L.Control.Locate=L.Control.extend({options:{position:"topleft",drawCircle:true,follow:true,stopFollowingOnDrag:false,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},circlePadding:[0,0],metric:true,onLocationError:function(e){alert(e.message)},onLocationOutsideMapBounds:function(e){alert(e.options.strings.outsideMapBoundsMsg)},setView:true,strings:{title:"Show me where I am (Mobile devices only)",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{}},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");var n=this;this._layer=new L.LayerGroup;this._layer.addTo(e);this._event=undefined;this._locateOptions={watch:true};L.extend(this._locateOptions,this.options.locateOptions);L.extend(this._locateOptions,{setView:false});var r={};L.extend(r,this.options.markerStyle,this.options.followMarkerStyle);this.options.followMarkerStyle=r;r={};L.extend(r,this.options.circleStyle,this.options.followCircleStyle);this.options.followCircleStyle=r;var i=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",t);i.href="#";i.title=this.options.strings.title;L.DomEvent.on(i,"click",L.DomEvent.stopPropagation).on(i,"click",L.DomEvent.preventDefault).on(i,"click",function(){if(n._active&&(e.getBounds().contains(n._event.latlng)||!n.options.setView||f())){h()}else{s()}}).on(i,"dblclick",L.DomEvent.stopPropagation);var s=function(){if(n.options.setView){n._locateOnNextLocationFound=true}if(!n._active){e.locate(n._locateOptions)}n._active=true;if(n.options.follow){u()}if(!n._event){L.DomUtil.addClass(n._container,"requesting");L.DomUtil.removeClass(n._container,"active");L.DomUtil.removeClass(n._container,"following")}else{l()}};var o=function(e){if(n._event&&n._event.latlng.lat===e.latlng.lat&&n._event.latlng.lng===e.latlng.lng&&n._event.accuracy===e.accuracy){return}if(!n._active){return}n._event=e;if(n.options.follow&&n._following){n._locateOnNextLocationFound=true}l()};var u=function(){e.fire("startfollowing");n._following=true;if(n.options.stopFollowingOnDrag){e.on("dragstart",a)}};var a=function(){e.fire("stopfollowing");n._following=false;if(n.options.stopFollowingOnDrag){e.off("dragstart",a)}l()};var f=function(){if(n._event===undefined)return false;return e.options.maxBounds&&!e.options.maxBounds.contains(n._event.latlng)};var l=function(){if(n._event.accuracy===undefined)n._event.accuracy=0;var t=n._event.accuracy;if(n._locateOnNextLocationFound){if(f()){n.options.onLocationOutsideMapBounds(n)}else{e.fitBounds(n._event.bounds,{padding:n.options.circlePadding})}n._locateOnNextLocationFound=false}var r,i;if(n.options.drawCircle){if(n._following){r=n.options.followCircleStyle}else{r=n.options.circleStyle}if(!n._circle){n._circle=L.circle(n._event.latlng,t,r).addTo(n._layer)}else{n._circle.setLatLng(n._event.latlng).setRadius(t);for(i in r){n._circle.options[i]=r[i]}}}var s,o;if(n.options.metric){s=t.toFixed(0);o="meters"}else{s=(t*3.2808399).toFixed(0);o="feet"}var u;if(n._following){u=n.options.followMarkerStyle}else{u=n.options.markerStyle}var a=n.options.strings.popup;if(!n._circleMarker){n._circleMarker=L.circleMarker(n._event.latlng,u).bindPopup(L.Util.template(a,{distance:s,unit:o})).addTo(n._layer)}else{n._circleMarker.setLatLng(n._event.latlng).bindPopup(L.Util.template(a,{distance:s,unit:o}))._popup.setLatLng(n._event.latlng);for(i in u){n._circleMarker.options[i]=u[i]}}if(!n._container)return;if(n._following){L.DomUtil.removeClass(n._container,"requesting");L.DomUtil.addClass(n._container,"active");L.DomUtil.addClass(n._container,"following")}else{L.DomUtil.removeClass(n._container,"requesting");L.DomUtil.addClass(n._container,"active");L.DomUtil.removeClass(n._container,"following")}};var c=function(){n._active=false;n._locateOnNextLocationFound=n.options.setView;n._following=false};c();var h=function(){e.stopLocate();e.off("dragstart",a);L.DomUtil.removeClass(n._container,"requesting");L.DomUtil.removeClass(n._container,"active");L.DomUtil.removeClass(n._container,"following");c();n._layer.clearLayers();n._circleMarker=undefined;n._circle=undefined};var p=function(e){if(e.code==3&&this._locateOptions.watch){return}h();n.options.onLocationError(e)};e.on("locationfound",o,n);e.on("locationerror",p,n);this.locate=s;this.stopLocate=h;this.stopFollowing=a;return t}});L.Map.addInitHook(function(){if(this.options.locateControl){this.locateControl=L.control.locate();this.addControl(this.locateControl)}});L.control.locate=function(e){return new L.Control.Locate(e)}